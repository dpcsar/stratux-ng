name: CI

on:
  pull_request:

permissions:
  contents: read

jobs:
  checks:
    name: Checks (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        runner:
          - ubuntu-latest
          - ubuntu-24.04-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: fmt-check
        run: make fmt-check

      - name: vet
        run: make vet

      - name: staticcheck
        run: make staticcheck

      - name: test
        run: make test

      - name: build
        run: make build

  image:
    name: Image build (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        runner:
          - ubuntu-latest
          - ubuntu-24.04-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Set up QEMU (for multi-arch containers)
        if: ${{ matrix.runner == 'ubuntu-latest' }}
        uses: docker/setup-qemu-action@v3

      - name: Install qemu-user-static (amd64 cross-build)
        if: ${{ matrix.runner == 'ubuntu-latest' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Make image (pi-gen)
        run: make image
